name: WordPress CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    name: Build and Deploy WordPress
    runs-on: ubuntu-latest
    
    # defaults:
    #   run:
    #     working-directory: /var/www/html/melvinmagro.online
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Debug SSH Connection
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > deploy_key.pem
          chmod 400 deploy_key.pem
          echo "Starting SSH connection"
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts  # Ensure the known_hosts file exists
          ssh-keyscan -H 51.20.52.140 >> ~/.ssh/known_hosts
          ssh -v -i ./deploy_key.pem ubuntu@51.20.52.140 "echo Hello from the server"

      - name: Set up SSH
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 51.20.52.140 >> ~/.ssh/known_hosts

      - name: Sync to Server
        env:
          DEST: 'ubuntu@51.20.52.140:/var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo/'
        run: |
          rsync -rav --delete --exclude='.git*' --exclude='.github*' --exclude='*.github*' -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" ./ ${{ env.DEST }}
      # - name: rsync
      #   env:
      #     dest: 'ubuntu@51.20.52.140:/var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo/'
      #   run: |
      #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > deploy_key.pem
      #     chmod 600 ./deploy_key.pem
      #     rsync -chav --delete \
      #       -e 'ssh -i ./deploy_key.pem -o StrictHostKeyChecking=no' \
      #       --exclude /deploy_key.pem \
      #       --exclude /.git/ \      
      #       --exclude /.github/ \
      #       ./ ${{env.dest}}
            
        # env:
        #   DEPLOYMENT_TOKEN: ${{ secrets.DEPLOYMENT_TOKEN }}

      # ssh -i ./deploy_key.pem ubuntu@51.20.52.140 "cd /var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo && npm install && npm run build"
          
      # - name: Install Node.js and npm and Build Theme Assets
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: 14

      # - name: Install dependencies
      #   run: |   
      #     scp -i ./deploy_key.pem -r /var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo ubuntu@51.20.52.140:/var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo
      #     ssh -i ./deploy_key.pem ubuntu@51.20.52.140 "cd /var/www/html/melvinmagro.online/wp-content/themes/twentytwentytwo && npm install && npm run build"

